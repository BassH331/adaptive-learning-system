<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Learning System Backend Code</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1, h2, h3 {
            color: #0056b3;
        }
        pre {
            background-color: #eee;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            font-family: "Courier New", Courier, monospace;
            background-color: #e9e9e9;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Adaptive Learning System Backend Code</h1>

        <p>This document provides the backend code for the Adaptive Learning System. It includes the <code>package.json</code> file for managing dependencies and the <code>server.js</code> file which contains the main application logic and API endpoints built with Node.js and Express.js.</p>

        <h2><code>backend/package.json</code></h2>
        <p>This file lists the project's dependencies and scripts.</p>
        <pre><code class="language-json">
{
  "name": "adaptive-learning-backend",
  "version": "1.0.0",
  "description": "Backend for the adaptive learning system",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "jsonwebtoken": "^9.0.2",
    "mysql2": "^3.9.7"
  }
}
        </code></pre>

        <h2><code>backend/server.js</code></h2>
        <p>This is the main server file containing the Express.js application, database connection, authentication middleware, and all API endpoints, including the adaptive learning algorithm logic.</p>
        <pre><code class="language-javascript">
require("dotenv").config();
const express = require("express");
const mysql = require("mysql2/promise");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const cors = require("cors");

const app = express();
const PORT = process.env.PORT || 5000;

app.use(cors());
app.use(express.json());

// Database connection pool
const pool = mysql.createPool({
  host: process.env.DB_HOST || "localhost",
  user: process.env.DB_USER || "root",
  password: process.env.DB_PASSWORD || "password",
  database: process.env.DB_NAME || "adaptive_learning_db",
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
});

// Test DB connection
pool.getConnection()
  .then((connection) => {
    console.log("Connected to MariaDB successfully!");
    connection.release();
  })
  .catch((err) => {
    console.error("Database connection failed:", err.stack);
    process.exit(1);
  });

// JWT Secret
const jwtSecret = process.env.JWT_SECRET || "supersecretjwtkey";

// Middleware for authentication
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers["authorization"];
  const token = authHeader && authHeader.split(" ")[1];

  if (token == null) return res.sendStatus(401); // No token

  jwt.verify(token, jwtSecret, (err, user) => {
    if (err) return res.sendStatus(403); // Invalid token
    req.user = user;
    next();
  });
};

// --- API Endpoints ---

// Register Student
app.post("/api/register", async (req, res) => {
  const { name, email, password, learning_style } = req.body;
  if (!name || !email || !password) {
    return res.status(400).json({ message: "Please enter all fields" });
  }

  try {
    const [existingUser] = await pool.execute(
      "SELECT * FROM students WHERE email = ?",
      [email]
    );
    if (existingUser.length > 0) {
      return res.status(400).json({ message: "User already exists" });
    }

    const hashedPassword = await bcrypt.hash(password, 10);
    await pool.execute(
      "INSERT INTO students (name, email, password, learning_style) VALUES (?, ?, ?, ?)",
      [name, email, hashedPassword, learning_style]
    );
    res.status(201).json({ message: "Student registered successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

// Login Student
app.post("/api/login", async (req, res) => {
  const { email, password } = req.body;
  if (!email || !password) {
    return res.status(400).json({ message: "Please enter all fields" });
  }

  try {
    const [users] = await pool.execute(
      "SELECT * FROM students WHERE email = ?",
      [email]
    );
    const user = users[0];

    if (!user) {
      return res.status(400).json({ message: "Invalid credentials" });
    }

    const isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch) {
      return res.status(400).json({ message: "Invalid credentials" });
    }

    const token = jwt.sign({ id: user.id, email: user.email }, jwtSecret, {
      expiresIn: "1h",
    });
    res.json({ token, user: { id: user.id, name: user.name, email: user.email, learning_style: user.learning_style } });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

// Get Student Profile (Protected)
app.get("/api/profile", authenticateToken, async (req, res) => {
  try {
    const [students] = await pool.execute(
      "SELECT id, name, email, learning_style FROM students WHERE id = ?",
      [req.user.id]
    );
    if (students.length === 0) {
      return res.status(404).json({ message: "Student not found" });
    }
    res.json(students[0]);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

// Update Student Profile (Protected)
app.put("/api/profile", authenticateToken, async (req, res) => {
  const { name, learning_style } = req.body;
  try {
    await pool.execute(
      "UPDATE students SET name = ?, learning_style = ? WHERE id = ?",
      [name, learning_style, req.user.id]
    );
    res.json({ message: "Profile updated successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

// --- CRUD for Courses ---
app.get("/api/courses", authenticateToken, async (req, res) => {
  try {
    const [courses] = await pool.execute("SELECT * FROM courses");
    res.json(courses);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

app.post("/api/courses", authenticateToken, async (req, res) => {
  const { name, description } = req.body;
  try {
    const [result] = await pool.execute(
      "INSERT INTO courses (name, description) VALUES (?, ?)",
      [name, description]
    );
    res.status(201).json({ id: result.insertId, name, description });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

// --- CRUD for Topics ---
app.get("/api/topics/:courseId", authenticateToken, async (req, res) => {
  const { courseId } = req.params;
  try {
    const [topics] = await pool.execute(
      "SELECT * FROM topics WHERE course_id = ?",
      [courseId]
    );
    res.json(topics);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

app.post("/api/topics", authenticateToken, async (req, res) => {
  const { course_id, name, description } = req.body;
  try {
    const [result] = await pool.execute(
      "INSERT INTO topics (course_id, name, description) VALUES (?, ?, ?)",
      [course_id, name, description]
    );
    res.status(201).json({ id: result.insertId, course_id, name, description });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

// --- CRUD for Study Materials ---
app.get("/api/materials/:topicId", authenticateToken, async (req, res) => {
  const { topicId } = req.params;
  try {
    const [materials] = await pool.execute(
      "SELECT * FROM study_materials WHERE topic_id = ?",
      [topicId]
    );
    res.json(materials);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

app.post("/api/materials", authenticateToken, async (req, res) => {
  const { topic_id, type, title, content_url, quiz_data } = req.body;
  try {
    const [result] = await pool.execute(
      "INSERT INTO study_materials (topic_id, type, title, content_url, quiz_data) VALUES (?, ?, ?, ?, ?)",
      [topic_id, type, title, content_url, JSON.stringify(quiz_data)]
    );
    res.status(201).json({ id: result.insertId, topic_id, type, title, content_url, quiz_data });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

// --- Student Progress ---
app.post("/api/progress", authenticateToken, async (req, res) => {
  const { topic_id, score, grade, status } = req.body;
  const student_id = req.user.id;
  try {
    await pool.execute(
      "INSERT INTO student_progress (student_id, topic_id, score, grade, status) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE score = VALUES(score), grade = VALUES(grade), status = VALUES(status), last_accessed = CURRENT_TIMESTAMP",
      [student_id, topic_id, score, grade, status]
    );
    res.status(201).json({ message: "Progress updated successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

app.get("/api/progress/:studentId", authenticateToken, async (req, res) => {
  const { studentId } = req.params;
  try {
    const [progress] = await pool.execute(
      "SELECT sp.*, t.name as topic_name, c.name as course_name FROM student_progress sp JOIN topics t ON sp.topic_id = t.id JOIN courses c ON t.course_id = c.id WHERE sp.student_id = ?",
      [studentId]
    );
    res.json(progress);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

// --- Adaptive Learning Algorithm (Simplified Heuristic) ---
app.get("/api/recommendations/:studentId", authenticateToken, async (req, res) => {
  const { studentId } = req.params;
  try {
    // Get student\'s learning style
    const [students] = await pool.execute(
      "SELECT learning_style FROM students WHERE id = ?",
      [studentId]
    );
    const learningStyle = students[0]?.learning_style || "visual"; // Default to visual

    // Get student\'s progress (topics with low scores or not completed)
    const [lowScoreTopics] = await pool.execute(
      "SELECT t.id, t.name, sp.score FROM topics t LEFT JOIN student_progress sp ON t.id = sp.topic_id AND sp.student_id = ? WHERE sp.score < 70 OR sp.score IS NULL ORDER BY sp.score ASC LIMIT 5",
      [studentId]
    );

    let recommendations = [];

    if (lowScoreTopics.length > 0) {
      for (const topic of lowScoreTopics) {
        // Recommend materials based on learning style for low-score topics
        const [materials] = await pool.execute(
          "SELECT * FROM study_materials WHERE topic_id = ? AND (type = ? OR type = ?) LIMIT 1",
          [topic.id, learningStyle === "visual" ? "video" : "pdf", learningStyle === "auditory" ? "video" : "pdf"]
        );
        if (materials.length > 0) {
          recommendations.push({
            topic: topic.name,
            material: materials[0],
            reason: `Improve score in ${topic.name} (score: ${topic.score || \'N/A\'})`,
          });
        } else {
            // Fallback if no specific learning style material is found
            const [anyMaterial] = await pool.execute(
                "SELECT * FROM study_materials WHERE topic_id = ? LIMIT 1",
                [topic.id]
            );
            if (anyMaterial.length > 0) {
                recommendations.push({
                    topic: topic.name,
                    material: anyMaterial[0],
                    reason: `Improve score in ${topic.name} (score: ${topic.score || \'N/A\'})`,
                });
            }
        }
      }
    } else {
      // If no low scores, recommend new topics or advanced materials
      const [newTopics] = await pool.execute(
        "SELECT t.id, t.name FROM topics t LEFT JOIN student_progress sp ON t.id = sp.topic_id AND sp.student_id = ? WHERE sp.student_id IS NULL LIMIT 3",
        [studentId]
      );

      for (const topic of newTopics) {
        const [materials] = await pool.execute(
          "SELECT * FROM study_materials WHERE topic_id = ? LIMIT 1",
          [topic.id]
        );
        if (materials.length > 0) {
          recommendations.push({
            topic: topic.name,
            material: materials[0],
            reason: `Explore new topic: ${topic.name}`,
          });
        }
      }
    }

    res.json(recommendations);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server error" });
  }
});

// Start server
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
        </code></pre>
    </div>
</body>
</html>

